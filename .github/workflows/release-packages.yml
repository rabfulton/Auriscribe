name: Build packages

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config git curl \
            libgtk-3-dev libayatana-appindicator3-dev libpulse-dev libjson-c-dev libcurl4-openssl-dev libx11-dev \
            dpkg-dev
          # Vulkan backend build deps (best effort across ubuntu-latest variants)
          sudo apt-get install -y libvulkan-dev || true
          sudo apt-get install -y glslc || sudo apt-get install -y shaderc || true

      - name: Build whisper.cpp
        run: ./scripts/setup-whisper.sh

      - name: Build .deb
        run: |
          VERSION="${{ github.ref_name }}" OUT_DIR=dist ./scripts/package-deb.sh

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb

  rpm:
    runs-on: ubuntu-latest
    container: fedora:39
    steps:
      - name: Install deps
        run: |
          dnf -y update
          dnf -y install git gcc make rpm-build pkgconfig \
            gtk3-devel pulseaudio-libs-devel json-c-devel libcurl-devel libX11-devel \
            which tar gzip \
            vulkan-loader-devel shaderc
          # Fedora names the Ayatana GTK3 appindicator package differently than Debian/Ubuntu.
          dnf -y install libayatana-appindicator-gtk3-devel || dnf -y install libayatana-appindicator-devel

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build whisper.cpp
        run: ./scripts/setup-whisper.sh

      - name: Build .rpm
        run: |
          VERSION="${{ github.ref_name }}" OUT_DIR=dist ./scripts/package-rpm.sh

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.rpm
